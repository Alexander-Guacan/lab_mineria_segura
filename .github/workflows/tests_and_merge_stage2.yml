name: Stage 2 - Auto Merge & Tests

on:
  workflow_run:
    workflows: ["Stage 1 - Security Analysis (ML + Heuristics)"]
    types:
      - completed

jobs:
  stage-2:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    # -------------------------------------------------
    # 1. Checkout repository
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -------------------------------------------------
    # 2. Setup Python
    # -------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # -------------------------------------------------
    # 3. Notify Telegram - Stage 2 start
    # -------------------------------------------------
    - name: Notify start of Stage 2
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python model/notify_telegram.py stage_start "Etapa 2 - Merge autom√°tico y pruebas"

    # -------------------------------------------------
    # 4. Auto-merge dev -> test
    # -------------------------------------------------
    - name: Auto merge dev into test
      run: |
        git checkout test
        git merge origin/dev --no-edit
        git push origin test

    # -------------------------------------------------
    # 5. Install backend test dependencies
    # -------------------------------------------------
    - name: Install backend dependencies
      run: |
        pip install fastapi pytest httpx

    # -------------------------------------------------
    # 6. Run backend tests
    # -------------------------------------------------
    - name: Run backend tests
      working-directory: src/backend
      run: |
        pytest
      continue-on-error: true
      id: backend_tests

    # -------------------------------------------------
    # 7. Setup Node.js
    # -------------------------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    # -------------------------------------------------
    # 8. Run frontend tests
    # -------------------------------------------------
    - name: Run frontend tests
      working-directory: src/frontend
      run: |
        npm ci
        npm run test
      continue-on-error: true
      id: frontend_tests

    # -------------------------------------------------
    # 9. Evaluate test results
    # -------------------------------------------------
    - name: Evaluate test results
      id: test_result
      run: |
        if [[ "${{ steps.backend_tests.outcome }}" == "failure" || "${{ steps.frontend_tests.outcome }}" == "failure" ]]; then
          echo "FAILED=true" >> $GITHUB_ENV
        else
          echo "FAILED=false" >> $GITHUB_ENV
        fi

    # -------------------------------------------------
    # 10. Create Issue if tests failed
    # -------------------------------------------------
    - name: Create issue on test failure
      if: env.FAILED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: "‚ùå Tests fallidos tras merge autom√°tico",
            body: `
            Se complet√≥ correctamente la **Etapa 1**, pero fallaron las pruebas en la **Etapa 2**.

            üìå Backend tests: ${{ steps.backend_tests.outcome }}
            üìå Frontend tests: ${{ steps.frontend_tests.outcome }}

            üîó Workflow:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `,
            labels: ["tests-failed"]
          })

    # -------------------------------------------------
    # 11. Notify Telegram - failure
    # -------------------------------------------------
    - name: Notify test failure
      if: env.FAILED == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python model/notify_telegram.py stage_fail "Etapa 2 - Fallaron las pruebas"

    # -------------------------------------------------
    # 12. Notify Telegram - success
    # -------------------------------------------------
    - name: Notify Stage 2 success
      if: env.FAILED == 'false'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python model/notify_telegram.py stage_success "Etapa 2 - Merge y pruebas completadas correctamente"
